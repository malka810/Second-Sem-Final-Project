<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Lecture Materials</title>

  <!-- font awesome cdn link  -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css">

  <!-- custom css file link  -->
  <link rel="stylesheet" href="../css/style.css">

  <style>
    /* Material Management Specific Styles */
    .material-management {
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: var(--white);
      border-radius: .5rem;
      box-shadow: var(--box-shadow);
      margin-bottom: 2rem;
      overflow: hidden;
    }

    .card-header {
      padding: 1.5rem 2rem;
      background: var(--main-color);
      color: white;
      font-size: 1.8rem;
      font-weight: 600;
    }

    .card-body {
      padding: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-control {
      width: 100%;
      padding: 1rem;
      font-size: 1.6rem;
      border: var(--border);
      border-radius: .5rem;
      background: var(--light-bg);
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 1.6rem;
      color: var(--black);
    }

    .text-danger {
      color: var(--red);
    }

    .btn-group {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .btn {
      padding: 1rem 2rem;
      border-radius: .5rem;
      font-size: 1.6rem;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-secondary {
      background: var(--light-color);
      color: white;
    }

    .btn-danger {
      background: var(--red);
      color: white;
    }

    .btn-warning {
      background: var(--orange);
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 1.4rem;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th, .table td {
      padding: 1.2rem;
      text-align: left;
      border-bottom: var(--border);
      font-size: 1.5rem;
    }

    .table th {
      background: var(--light-bg);
      font-weight: 600;
    }

    .table tr:hover {
      background: rgba(155, 46, 213, 0.05);
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .file-preview {
      max-width: 100px;
      max-height: 100px;
      border-radius: .5rem;
      border: var(--border);
      display: none;
    }

    .badge {
      display: inline-block;
      padding: 0.35em 0.65em;
      font-size: 0.75em;
      font-weight: 700;
      line-height: 1;
      text-align: center;
      white-space: nowrap;
      vertical-align: baseline;
      border-radius: 0.25rem;
    }

    .bg-success {
      background-color: #28a745;
      color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .table-responsive {
        overflow-x: auto;
      }

      .btn-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

<header class="header">
  <section class="flex">
    <a href="../instructorDashboard.html" class="logo">
      <img src="../images/logo.png" class="image" alt="">
      <b id="logoN" style="color: #9b2ed5">EduNexus</b>
    </a>

    <form action="../search.html" method="post" class="search-form">
      <input type="text" name="search_box" required placeholder="search materials..." maxlength="100">
      <button type="submit" class="fas fa-search"></button>
    </form>

    <div class="icons">
      <div id="menu-btn" class="fas fa-bars"></div>
      <div id="search-btn" class="fas fa-search"></div>
      <div id="user-btn" class="fas fa-user"></div>
      <div id="toggle-btn" class="fas fa-sun"></div>
      <a href="../index.html" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i>
        <span class="logout-text">Logout</span>
      </a>
    </div>

    <div class="profile">
      <img src="../images/User.png" width="80" height="80" class="image" alt="">
      <p class="role">Instructor</p>
      <a href="../profile.html" class="btn">view profile</a>
    </div>
  </section>
</header>

<div class="side-bar">
  <div id="close-btn">
    <i class="fas fa-times"></i>
  </div>

  <div class="profile">
    <img src="../images/User.png" class="image" alt="">
    <p class="role">Instructor</p>
    <a href="../profile.html" class="btn">view profile</a>
  </div>

  <nav class="navbar">
    <a href="../instructorDashboard.html"><i class="fas fa-home"></i><span>Dashboard</span></a>
    <a href="upload-materials.html" class="active"><i class="fas fa-upload"></i><span>Upload Materials</span></a>
    <a href="my-courses.html"><i class="fas fa-book"></i><span>My Courses</span></a>
    <a href="student-progress.html"><i class="fas fa-chart-line"></i><span>Student Progress</span></a>
    <a href="instructor-settings.html"><i class="fas fa-cog"></i><span>Settings</span></a>
  </nav>
</div>

<section class="material-management">
  <!-- Material Form -->
  <div class="card">
    <div class="card-header">
      <i class="fas fa-upload"></i> Upload Lecture Material
    </div>
    <div class="card-body">
      <form id="materialForm">
        <!-- Title Field -->
        <div class="form-group">
          <label for="materialTitle" class="form-label">Material Title <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="materialTitle" placeholder="Enter material title" required>
        </div>

        <!-- File Upload -->
        <div class="form-group">
          <label for="materialFile" class="form-label">Lecture File <span class="text-danger">*</span></label>
          <input type="file" class="form-control" id="materialFile" required accept=".pdf,.ppt,.pptx,.doc,.docx,.mp4,.mov,.avi">
          <small class="text-muted">Supported formats: PDF, PPT, DOC, MP4, MOV, AVI</small>
          <div class="mt-2">
            <img id="filePreview" class="file-preview" alt="File Preview">
          </div>
        </div>

        <!-- Hidden field for material ID -->
        <input type="hidden" id="materialId">

        <!-- Action Buttons -->
        <div class="btn-group">
          <button type="button" class="btn btn-secondary" id="resetMaterialBtn">
            <i class="fas fa-undo"></i> Reset
          </button>
          <button type="button" class="btn btn-danger" id="deleteMaterialBtn" style="display: none;">
            <i class="fas fa-trash"></i> Delete
          </button>
          <button type="button" class="btn btn-warning" id="updateMaterialBtn" style="display: none;">
            <i class="fas fa-pencil-alt"></i> Update
          </button>
          <button type="submit" class="btn btn-success" id="saveMaterialBtn">
            <i class="fas fa-save"></i> Upload
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Materials Table -->
  <div class="card">
    <div class="card-header">
      <i class="fas fa-list"></i> Lecture Materials
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table">
          <thead>
          <tr>
            <th>Title</th>
            <th>File Type</th>
            <th>Upload Date</th>
            <th>Course</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody id="materialTableBody">
          <!-- Materials will be loaded here dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<footer class="footer">
  &copy; copyright @ 2025 by <span>EduNexus</span> | all rights reserved!
</footer>

<!-- jQuery -->
<script src="../js/jquery.js"></script>
<!-- Custom JS -->
<script src="../js/script.js"></script>

<script>
  // Global variable to store current material data
  let currentMaterial = null;
  let currentCourse = null;

  // Load all materials for the instructor's courses
  function loadMaterials() {
    // In a real implementation, this would fetch only materials for courses this instructor teaches
    $.ajax({
      url: "http://localhost:3030/api/v1/material/instructor",
      type: "GET",
      headers: {
        "Authorization": "Bearer " + localStorage.getItem("authToken")
      },
      success: function(response) {
        const tableBody = $("#materialTableBody");
        tableBody.empty();

        response.data.forEach(material => {
          const fileType = getFileType(material.fileUrl);
          const fileIcon = getFileIcon(fileType);

          const row = `
                        <tr>
                            <td>${material.title}</td>
                            <td><i class="fas ${fileIcon}"></i> ${fileType.toUpperCase()}</td>
                            <td>${new Date(material.uploadAt).toLocaleDateString()}</td>
                            <td>${material.courseTitle}</td>
                            <td class="action-buttons">
                                <button class="btn btn-warning btn-sm edit-material-btn" data-id="${material.materialId}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm delete-material-btn" data-id="${material.materialId}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                <a href="${material.fileUrl}" class="btn btn-info btn-sm" target="_blank">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </td>
                        </tr>
                    `;
          tableBody.append(row);
        });
      },
      error: function(xhr) {
        console.error("Error loading materials:", xhr);
        alert("Error loading materials: " + (xhr.responseJSON?.message || "Server error"));
      }
    });
  }

  // Get file type from URL
  function getFileType(fileUrl) {
    const extension = fileUrl.split('.').pop().toLowerCase();
    if (['pdf'].includes(extension)) return 'pdf';
    if (['ppt', 'pptx'].includes(extension)) return 'presentation';
    if (['doc', 'docx'].includes(extension)) return 'document';
    if (['mp4', 'mov', 'avi'].includes(extension)) return 'video';
    return 'file';
  }

  // Get appropriate icon for file type
  function getFileIcon(fileType) {
    switch(fileType) {
      case 'pdf': return 'fa-file-pdf';
      case 'presentation': return 'fa-file-powerpoint';
      case 'document': return 'fa-file-word';
      case 'video': return 'fa-file-video';
      default: return 'fa-file';
    }
  }

  // Form reset function
  function resetMaterialForm() {
    $("#materialForm")[0].reset();
    $("#filePreview").hide();
    $("#materialId").val("");
    $("#deleteMaterialBtn, #updateMaterialBtn").hide();
    $("#saveMaterialBtn").show();
    currentMaterial = null;
  }

  // Save/Upload new material
  $("#materialForm").submit(function(e) {
    e.preventDefault();

    const formData = new FormData();
    formData.append("title", $("#materialTitle").val());
    formData.append("courseId", currentCourse.courseId); // In real implementation, get current course
    formData.append("courseTitle", currentCourse.title); // In real implementation, get current course
    formData.append("file", $("#materialFile")[0].files[0]);

    $.ajax({
      type: "POST",
      url: "http://localhost:3030/api/v1/material/upload",
      data: formData,
      processData: false,
      contentType: false,
      headers: {
        "Authorization": "Bearer " + localStorage.getItem("authToken")
      },
      success: function(response) {
        alert("Material uploaded successfully!");
        resetMaterialForm();
        loadMaterials();
      },
      error: function(xhr) {
        console.error("Error uploading material:", xhr);
        alert("Error uploading material: " + (xhr.responseJSON?.message || "Server error"));
      }
    });
  });

  // Edit material
  $(document).on("click", ".edit-material-btn", function() {
    const materialId = $(this).data("id");

    $.ajax({
      type: "GET",
      url: `http://localhost:3030/api/v1/material/${materialId}`,
      headers: {
        "Authorization": "Bearer " + localStorage.getItem("authToken")
      },
      success: function(response) {
        currentMaterial = response.data;

        $("#materialId").val(currentMaterial.materialId);
        $("#materialTitle").val(currentMaterial.title);

        // Show preview if available
        if (currentMaterial.fileUrl) {
          const fileType = getFileType(currentMaterial.fileUrl);
          if (fileType === 'video') {
            $("#filePreview").attr("src", "../images/video-thumbnail.png");
          } else {
            $("#filePreview").attr("src", `../images/${fileType}-icon.png`);
          }
          $("#filePreview").show();
        }

        $("#deleteMaterialBtn, #updateMaterialBtn").show();
        $("#saveMaterialBtn").hide();
      },
      error: function(xhr) {
        console.error("Error fetching material:", xhr);
        alert("Error fetching material: " + (xhr.responseJSON?.message || "Server error"));
      }
    });
  });

  // Update material
  $("#updateMaterialBtn").click(function() {
    if (!currentMaterial) return;

    const formData = new FormData();
    formData.append("title", $("#materialTitle").val());

    const newFile = $("#materialFile")[0].files[0];
    if (newFile) {
      formData.append("file", newFile);
    }

    $.ajax({
      type: "PUT",
      url: `http://localhost:3030/api/v1/material/update/${currentMaterial.materialId}`,
      data: formData,
      processData: false,
      contentType: false,
      headers: {
        "Authorization": "Bearer " + localStorage.getItem("authToken")
      },
      success: function(response) {
        alert("Material updated successfully!");
        resetMaterialForm();
        loadMaterials();
      },
      error: function(xhr) {
        console.error("Error updating material:", xhr);
        alert("Error updating material: " + (xhr.responseJSON?.message || "Server error"));
      }
    });
  });

  // Delete material
  $("#deleteMaterialBtn").click(function() {
    if (!currentMaterial || !confirm("Are you sure you want to delete this material?")) return;

    $.ajax({
      type: "DELETE",
      url: `http://localhost:3030/api/v1/material/delete/${currentMaterial.materialId}`,
      headers: {
        "Authorization": "Bearer " + localStorage.getItem("authToken")
      },
      success: function(response) {
        alert("Material deleted successfully!");
        resetMaterialForm();
        loadMaterials();
      },
      error: function(xhr) {
        console.error("Error deleting material:", xhr);
        alert("Error deleting material: " + (xhr.responseJSON?.message || "Server error"));
      }
    });
  });

  // Preview file selection
  $("#materialFile").change(function(event) {
    const file = event.target.files[0];
    const preview = $("#filePreview");

    if (file) {
      const fileType = file.type.split('/')[0];
      if (fileType === 'image') {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.attr("src", e.target.result);
          preview.show();
        }
        reader.readAsDataURL(file);
      } else {
        // Show generic icon based on file type
        const extension = file.name.split('.').pop().toLowerCase();
        preview.attr("src", `../images/${getFileType(file.name)}-icon.png`);
        preview.show();
      }
    } else {
      preview.hide();
    }
  });

  // Reset form button
  $("#resetMaterialBtn").click(resetMaterialForm);

  // Initialize on page load
  $(document).ready(function() {
    // In a real implementation, you would load the current course first
    // For demo purposes, we'll use a mock course
    currentCourse = {
      courseId: "123e4567-e89b-12d3-a456-426614174000",
      title: "Advanced Web Development"
    };

    loadMaterials();
    resetMaterialForm();
  });
</script>
</body>
</html>